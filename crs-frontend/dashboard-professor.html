<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ø³ØªØ§Ø¯ â€” Ø³Ø§Ù…Ø§Ù†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ ÙˆØ§Ø­Ø¯</title>
    <link rel="stylesheet" href="css/dashboard-admin.css" />
  </head>
  <body>
    <div id="app" class="app-root">
      <!-- SIDEBAR -->
      <aside class="sidebar" id="sidebar" aria-label="Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ">
        <div class="brand">
          <div class="logo">
            <img
              src="images/logo.jpg"
              alt="University Logo"
              style="width: 100%; height: 100%; border-radius: 12px"
            />
          </div>
          <div class="brand-txt">
            <div class="title">Ø³Ø§Ù…Ø§Ù†Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ ÙˆØ§Ø­Ø¯</div>
            <div class="subtitle muted">Ù¾Ù†Ù„ Ø§Ø³ØªØ§Ø¯</div>
          </div>
        </div>

        <nav class="menu" role="navigation" aria-label="Ù†Ø§ÙˆØ¨Ø±ÛŒ Ø§ØµÙ„ÛŒ">
          <button
            class="menu-item active"
            data-panel="section"
            aria-pressed="true"
          >
            ğŸ“… Ø³Ú©Ø´Ù†â€ŒÙ‡Ø§ÛŒ Ù…Ù†
          </button>
        </nav>

        <div class="sidebar-footer">
          <div class="muted small">Ù†Ø³Ø®Ù‡ 1.0</div>
          <div class="muted small">Â© Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡</div>
        </div>
      </aside>

      <!-- MAIN -->
      <div class="main-area">
        <!-- header -->
        <header class="topbar" role="banner">
          <div class="left">
            <button id="mobileToggle" class="icon-btn" aria-label="Ù†Ù…Ø§ÛŒØ´ Ù…Ù†Ùˆ">
              â˜°
            </button>
            <h1 id="pageTitle" class="page-title">Ø³Ú©Ø´Ù†â€ŒÙ‡Ø§ÛŒ Ù…Ù†</h1>
          </div>

          <div class="right">
            <div class="user-pill" id="userPill" aria-hidden="false">
              <div class="avatar" id="avatar"></div>
              <div class="user-info">
                <div id="userName">Ø§Ø³ØªØ§Ø¯</div>
                <div class="muted small" id="userRole">PROFESSOR</div>
              </div>
            </div>
            <button id="btnLogout" class="btn ghost">Ø®Ø±ÙˆØ¬</button>
          </div>
        </header>

        <!-- content -->
        <main class="content" id="content" role="main">
          <!-- PANEL: SECTION (read-only) -->
          <section
            id="panel-section"
            class="panel panel--active"
            aria-labelledby="pageTitle"
          >
            <div class="panel-header">
              <h2>Ø³Ú©Ø´Ù†â€ŒÙ‡Ø§ÛŒ Ù…Ù†</h2>
              <div class="panel-actions">
                <input
                  id="secSearchProf"
                  type="text"
                  class="search-input"
                  placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø±Ø³ØŒ Ú©Ù„Ø§Ø³ ÛŒØ§ Ø±ÙˆØ²..."
                  style="max-width: 260px"
                />
              </div>
            </div>
            <div class="table-wrap" aria-live="polite">
              <table
                class="table"
                id="sectionsTable"
                role="table"
                aria-label="Ù„ÛŒØ³Øª Ø³Ú©Ø´Ù†â€ŒÙ‡Ø§"
              >
                <thead>
                  <tr>
                    <th scope="col">Ø¯Ø±Ø³</th>
                    <th scope="col">Ú©Ù„Ø§Ø³</th>
                    <th scope="col">Ø¸Ø±ÙÛŒØª</th>
                    <th scope="col">ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ø´Ø¬Ùˆ</th>
                    <th scope="col">Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ</th>
                  </tr>
                </thead>
                <tbody id="sectionsTbody">
                  <tr>
                    <td colspan="5" class="muted">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>
        </main>
      </div>
    </div>

    <script src="js/api.js"></script>
    <script>
      const dayNamesFa = {
        MONDAY: "Ø¯ÙˆØ´Ù†Ø¨Ù‡",
        TUESDAY: "Ø³Ù‡\u200cØ´Ù†Ø¨Ù‡",
        WEDNESDAY: "Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡",
        THURSDAY: "Ù¾Ù†Ø¬Ø´Ù†Ø¨Ù‡",
        FRIDAY: "Ø¬Ù…Ø¹Ù‡",
        SATURDAY: "Ø´Ù†Ø¨Ù‡",
        SUNDAY: "ÛŒÚ©Ø´Ù†Ø¨Ù‡",
      };

      const sectionsTbody = document.getElementById("sectionsTbody");

      function getToken() {
        return (
          localStorage.getItem("accessToken") ||
          sessionStorage.getItem("accessToken")
        );
      }

      function decodeTokenPayload() {
        const tok = getToken();
        if (!tok) return null;
        try {
          const payload = JSON.parse(
            atob(tok.split(".")[1].replace(/-/g, "+").replace(/_/g, "/"))
          );
          return payload;
        } catch (e) {
          console.warn("token decode failed", e);
          return null;
        }
      }

      function loadProfessorHeader() {
        const payload = decodeTokenPayload();
        if (!payload) return;
        const name = payload.firstName
          ? payload.firstName + (payload.lastName ? " " + payload.lastName : "")
          : payload.username || "Ø§Ø³ØªØ§Ø¯";
        document.getElementById("userName").textContent = name;
        document.getElementById("userRole").textContent =
          payload.role || "PROFESSOR";
        const avatar = document.getElementById("avatar");
        avatar.textContent = (name[0] || "P").toUpperCase();
      }

      async function loadSectionsForProfessor() {
        sectionsTbody.innerHTML =
          '<tr><td colspan="5" class="muted">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td></tr>';
        try {
          const data = await apiFetch("/section", { method: "GET" });
          const sections = Array.isArray(data) ? data : [];
          if (!sections.length) {
            sectionsTbody.innerHTML =
              '<tr><td colspan="5" class="muted">Ù‡ÛŒÚ† Ø³Ú©Ø´Ù†ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</td></tr>';
            return;
          }

          // Ø§Ú¯Ø± backend Ø®ÙˆØ¯Ø´ ÙÛŒÙ„ØªØ± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ø³ØªØ§Ø¯ Ø§Ù†Ø¬Ø§Ù… Ù†Ù…ÛŒ\u200cØ¯Ù‡Ø¯ØŒ
          // Ù…ÛŒ\u200cØªÙˆØ§Ù†ÛŒØ¯ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø±Ø§Ø³Ø§Ø³ payload Ù¾Ø±ÙˆÙØ³ÙˆØ± ÙÛŒÙ„ØªØ± Ú©Ù†ÛŒØ¯.

          sectionsTbody.innerHTML = sections
            .map((s) => {
              const lessonTitle = (s.lesson && s.lesson.title) || "-";
              const classroomLabel =
                (s.classroom && s.classroom.room_number) || "-";
              const capacity = s.capacity ?? "-";
              const studentsCount = Array.isArray(s.students)
                ? s.students.length
                : 0;
              const schedulesText = Array.isArray(s.schedules)
                ? s.schedules
                    .map((sch) => {
                      const dow = sch.day_of_week || "";
                      const st = sch.start_time || "";
                      const et = sch.endTime || "";
                      if (!dow && !st && !et) return "";
                      const faDay = dayNamesFa[dow] || dow;
                      return `${faDay} ${st}-${et}`.trim();
                    })
                    .filter(Boolean)
                    .join("<br>")
                : "";

              return `<tr>
                <td>${lessonTitle}</td>
                <td>${classroomLabel}</td>
                <td>${capacity}</td>
                <td>${studentsCount}</td>
                <td>${schedulesText || "-"}</td>
              </tr>`;
            })
            .join("");
        } catch (err) {
          console.error(err);
          sectionsTbody.innerHTML =
            '<tr><td colspan="5" class="muted">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø³Ú©Ø´Ù†\u200cÙ‡Ø§</td></tr>';
        }
      }

      document.getElementById("mobileToggle").addEventListener("click", () => {
        const sb = document.getElementById("sidebar");
        sb.classList.toggle("open");
      });

      document.addEventListener("click", (e) => {
        if (window.innerWidth < 1000) {
          if (
            !e.target.closest("#sidebar") &&
            !e.target.closest("#mobileToggle")
          )
            document.getElementById("sidebar").classList.remove("open");
        }
      });

      document.getElementById("btnLogout").addEventListener("click", () => {
        localStorage.removeItem("accessToken");
        sessionStorage.removeItem("accessToken");
        window.location.href = "index.html";
      });

      (function init() {
        loadProfessorHeader();
        loadSectionsForProfessor();
      })();
    </script>
  </body>
</html>
